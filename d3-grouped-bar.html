<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="d3-import.html">

<dom-module id="d3-grouped-bar">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <svg width="560" height="400"></svg>
  </template>

  <script>
    /**
     * `d3-grouped-bar`
     * D3 Grouped Bar as Polymer Element
     *
     * @customElement
     * @polymer
     * @demo demo/d3-grouped-bar.html
     */
    class D3GroupedBar extends Polymer.Element {
      static get is() {
        return 'd3-grouped-bar';
      }

      static get properties() {
        return {
          /**
           {
               datasets: [{
                   label: '# of Votes',
                   data: [10, 20, 30]
               }],
               labels: [
                   'Red',
                   'Yellow',
                   'Blue'
               ]
           }
           **/
          data: Object,
        };
      }

      static get observers() {
        return ['dataChanged(data.*)'];
      }

      dataChanged() {
        console.log(this.data);
      }

      _initializeSVG() {
        this.svg = d3.select(this.shadowRoot.querySelector('svg'));
      }

      _getWidth() {
        return +this.svg.attr('width') - this.margin.left - this.margin.right;
      }

      _getHeight() {
        return +this.svg.attr('height') - this.margin.top - this.margin.bottom;
      }

      _getDimensions() {
        this.margin = {top: 20, right: 20, bottom: 30, left: 40};
        this.width = this._getWidth();
        this.height = this._getHeight();
      }

      _isDataAvailable() {
        return !!this.data;
      }

      _draw() {
        if (!this._isDataAvailable()) {
          return false;
        }

        this._initializeSVG();
        this._getDimensions();

        let g = this.svg.append('g')
          .attr('transform',
            'translate(' + this.margin.left + ',' + this.margin.top + ')');

        let x0 = d3.scaleBand()
          .rangeRound([0, this.width])
          .paddingInner(0.1);

        let x1 = d3.scaleBand()
          .padding(0.05);

        let y = d3.scaleLinear()
          .rangeRound([this.height, 0]);

        let z = d3.scaleOrdinal()
          .range(['#98abc5', '#8a89a6', '#7b6888',
            '#6b486b', '#a05d56', '#d0743c', '#ff8c00']);

        let keys = this.data.datasets.map((item) => item.label);

        x0.domain(this.data.labels);
        x1.domain(keys).rangeRound([0, x0.bandwidth()]);
        y.domain([0, d3.max(this.data.datasets, function(d) {
          return d3.max(d.data, function(value) {
            return value;
          });
        })]).nice();

        g.append('g')
          .selectAll('g')
          .data(this.data.labels)
          .enter().append('g')
          .attr('transform', function(d) {
            return 'translate(' + x0(d) + ',0)';
          })
          .selectAll('rect')
          .data((d, i) => {
            return this.data.datasets.map((dataset) => {
              return {key: dataset.label, value: dataset.data[i]};
            });
          })
          .enter().append('rect')
          .attr('x', function(d) {
            return x1(d.key);
          })
          .attr('y', function(d) {
            return y(d.value);
          })
          .attr('width', x1.bandwidth())
          .attr('height', function(d) {
            return this.height - y(d.value);
          }.bind(this))
          .attr('fill', function(d) {
            return z(d.key);
          });

        g.append('g')
          .attr('class', 'axis')
          .attr('transform', 'translate(0,' + this.height + ')')
          .call(d3.axisBottom(x0));

        g.append('g')
          .attr('class', 'axis')
          .call(d3.axisLeft(y).ticks(null, 's'))
          .append('text')
          .attr('x', 2)
          .attr('y', y(y.ticks().pop()) + 0.5)
          .attr('dy', '0.32em')
          .attr('fill', '#000')
          .attr('font-weight', 'bold')
          .attr('text-anchor', 'start')
          .text('Population');

        var legend = g.append('g')
          .attr('font-family', 'sans-serif')
          .attr('font-size', 10)
          .attr('text-anchor', 'end')
          .selectAll('g')
          .data(keys.slice().reverse())
          .enter().append('g')
          .attr('transform', function(d, i) {
            return 'translate(0,' + i * 20 + ')';
          });

        legend.append('rect')
          .attr('x', this.width - 19)
          .attr('width', 19)
          .attr('height', 19)
          .attr('fill', z);

        legend.append('text')
          .attr('x', this.width - 24)
          .attr('y', 9.5)
          .attr('dy', '0.32em')
          .text(function(d) {
            return d;
          });
      }

      connectedCallback() {
        super.connectedCallback();
        this._draw();
      }
    }

    window.customElements.define(D3GroupedBar.is, D3GroupedBar);
  </script>
</dom-module>
